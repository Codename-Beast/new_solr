# Apache VirtualHost for Solr Admin UI
# Generated by Eledia Solr Ansible Role v3.3.1
# Domain: solr.{{ moodle_app_domain | default(inventory_hostname) }}

<VirtualHost *:80>
    ServerName solr.{{ moodle_app_domain | default(inventory_hostname) }}
    ServerAdmin support@eledia.de
    Redirect permanent / https://solr.{{ moodle_app_domain | default(inventory_hostname) }}/
    TransferLog /var/log/apache2/transfer.solr.{{ moodle_app_domain | default(inventory_hostname) }}.log
</VirtualHost>

<VirtualHost *:443>
    ServerName solr.{{ moodle_app_domain | default(inventory_hostname) }}
    ServerAdmin support@eledia.de

    # Security Headers
    RedirectMatch 404 \/\.git
    RedirectMatch 404 \/\.scripts
    RedirectMatch 404 README.md
    
    # SSL Configuration
    SSLEngine On
    {% set base_domain = moodle_app_domain | default(inventory_hostname) %}
    {% if base_domain.startswith('solr.') %}
        {% set cert_domain = base_domain | regex_replace('^solr\.', '') %}
    {% else %}
        {% set cert_domain = base_domain %}
    {% endif %}
    
    # Try to use existing certificate from main domain
    {% if letsencrypt_cert_exists | default(false) %}
    SSLCertificateFile /etc/letsencrypt/live/{{ cert_domain }}/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ cert_domain }}/privkey.pem
    SSLCACertificateFile /etc/letsencrypt/live/{{ cert_domain }}/chain.pem
    {% else %}
    # Using default SSL certificates (install certbot certificates)
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
    {% endif %}

    # Proxy Configuration for Solr
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:{{ solr_docker_port | default('8983') }}/solr/
    ProxyPassReverse / http://127.0.0.1:{{ solr_docker_port | default('8983') }}/solr/
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Directory Security
    <Directory />
        Options +FollowSymLinks
        AllowOverride None
        Require all denied
    </Directory>

    # Allow access to Solr (with authentication if enabled)
    <Location "/">
        {% if solr_admin_user is defined and solr_admin_password is defined %}
        # Basic Authentication (Optional - Solr has its own auth)
        # AuthType Basic
        # AuthName "Solr Admin Access"
        # AuthUserFile /etc/apache2/.htpasswd-solr
        # Require valid-user
        {% endif %}
        
        # Allow access from all IPs (Solr has internal authentication)
        Require all granted
    </Location>

    # Logging
    ErrorLog /var/log/apache2/solr.{{ moodle_app_domain | default(inventory_hostname) }}_ssl_error.log
    CustomLog /var/log/apache2/solr.{{ moodle_app_domain | default(inventory_hostname) }}_ssl_access.log combined
    
</VirtualHost>